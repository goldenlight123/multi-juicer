# Example Setup with AWS

**WARNING:** The resources created in this guide will cost about \$70.00/month. The actual price might depend on its usage, but make sure to delete the resources as described in Step 5 Deinstallation when you do not need them anymore.

## Prerequisites

This example expects you to have the following cli tools setup.

1. [awscli](https://aws.amazon.com/cli/)
2. [eksctl](https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html)
3. [helm](https://helm.sh)
4. [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-macos)

```sh
# First we'll need a cluster, you can create one using the DigitalOcean cli.
# This will take a couple of minutes
eksctl create cluster \
--name juicy-ctf \
--version 1.13 \
--nodegroup-name standard-workers \
--node-type t3.medium \
--nodes 2 \
--nodes-min 1 \
--nodes-max 4 \
--node-ami auto

# After completion verify that your kubectl context has been updated:
# Should print something like: Administrator@juicy-ctf.eu-central-1.eksctl.io
kubectl config current-context
```

## Step 2. Installing JuicyCTF via helm

```sh
# We'll need to clone this git repo for the moment, as the helm chart isn't pushed to any registry
git clone git@github.com:J12934/juicy-ctf.git

# First we'll need to fetch the charts JuicyCTF depends on
helm dependency update ./juicy-ctf/helm/juicy-ctf/

# Now we can install the helm chart
# The first juicy-ctf part is the release name, safe to change to whatever you like, but the examples in the guide are written for 'juicy-ctf'
helm install juicy-ctf ./juicy-ctf/helm/juicy-ctf/

# kubernetes will now spin up the pods
# to verify every thing is starting up, run:
kubectl get pods
# This should show you three pods a juice-balancer pod and two redis pods
# Wait until all 3 pods are ready
```

## Step 3. Verify the app is running correctly

This step is optional, but helpful to catch errors quicker.

```sh
# lets test out if the app is working correctly before proceeding
# for that we can port forward the JuiceBalancer service to your local machine
kubectl port-forward service/juice-balancer 3000:3000

# Open up your browser for localhost:3000
# You should be able to see the JuicyCTF Balancer UI

# Try to create a team and see if everything works correctly
# You should be able to access a JuiceShop instances after a few seconds after creating a team,
# and after clicking the "Start Hacking" Button

# You can also try out if the admin UI works correctly
# Go back to localhost:3000/balancer
# To log in as the admin log in as the team "admin"
# The password for the team gets autogenerated if not specified, you can extract it from the kubernetes secret:
kubectl get secrets juice-balancer-secret -o=jsonpath='{.data.adminPassword}' | base64 --decode
```

## Step 4. Add Ingress to expose the app to the world

AWS let's you create LoadBalancer by adding a new ingress config to you cluster.
To set this up follow the **To deploy the ALB Ingress Controller to an Amazon EKS cluster** guide on https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html closely. This will walk you through setting up and configuring the ingress.

After you have set that up we can now create a ingress config for our the JuicyCTF Stack.

```sh
# create the ingress for the JuiceBalancer service
kubectl apply -f juicy-ctf/examples/aws/aws-ingress.yaml
```

## Step 5. Deinstallation

helm delete juicy-ctf

```sh
# helm will not delete the persistent volumes for redis!
# delete them by running:
kubectl delete persistentvolumeclaims redis-data-juicy-ctf-redis-master-0 redis-data-juicy-ctf-redis-slave-0

# Delete the loadbalancer
kubectl delete -f juicy-ctf/examples/aws/aws-ingress.yaml

# Delete the kubernetes cluster
eksctl delete cluster juicy-ctf
```
